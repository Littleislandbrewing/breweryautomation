alias: "NB: GENERAL: 6: CLT to HLT/KETTLE Overflow Safety (V1.0)"
description: Emergency stop CLT transfers on overflow - prevents tank overfill
triggers:
  - entity_id: sensor.prct_current_hlt_volume
    above: 1400
    trigger: numeric_state
  - entity_id: sensor.prct_current_kettle_volume
    above: 1200
    trigger: numeric_state
actions:
  - choose:
      - conditions:
          - condition: numeric_state
            entity_id: sensor.prct_current_hlt_volume
            above: 1400
          - condition: state
            entity_id: input_boolean.prc_clt_to_hlt
            state: "on"
        sequence:
          - action: system_log.write
            data:
              message: >-
                ‚ö†Ô∏è CRITICAL: HLT OVERFLOW DETECTED ({{
                states('sensor.prct_current_hlt_volume') }}L > 1400L) -
                EMERGENCY STOP CLT‚ÜíHLT
              level: critical
          - action: persistent_notification.create
            data:
              title: üö® HLT OVERFLOW SAFETY
              message: |
                **EMERGENCY STOP ACTIVATED**

                HLT Volume: {{ states('sensor.prct_current_hlt_volume') }}L
                Limit: 1400L

                CLT‚ÜíHLT transfer forcibly stopped.
          - action: input_boolean.turn_off
            target:
              entity_id: input_boolean.prc_clt_to_hlt
          - action: system_log.write
            data:
              message: ‚ö†Ô∏è CLT‚ÜíHLT transfer stopped by overflow safety
              level: critical
      - conditions:
          - condition: numeric_state
            entity_id: sensor.prct_current_kettle_volume
            above: 1200
          - condition: state
            entity_id: input_boolean.prc_clt_to_kettle
            state: "on"
        sequence:
          - action: system_log.write
            data:
              message: >-
                ‚ö†Ô∏è CRITICAL: KETTLE OVERFLOW DETECTED ({{
                states('sensor.prct_current_kettle_volume') }}L > 1200L) -
                EMERGENCY STOP CLT‚ÜíKETTLE
              level: critical
          - action: persistent_notification.create
            data:
              title: üö® KETTLE OVERFLOW SAFETY
              message: >
                **EMERGENCY STOP ACTIVATED**


                Kettle Volume: {{ states('sensor.prct_current_kettle_volume')
                }}L

                Limit: 1200L


                CLT‚ÜíKETTLE transfer forcibly stopped.
          - action: input_boolean.turn_off
            target:
              entity_id: input_boolean.prc_clt_to_kettle
          - action: system_log.write
            data:
              message: ‚ö†Ô∏è CLT‚ÜíKETTLE transfer stopped by overflow safety
              level: critical
mode: single
max_exceeded: silent
